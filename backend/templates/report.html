<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Security Scan Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Print Optimization */
        @media print {
            body { background-color: white; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .card { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; }
            .bg-slate-900, .bg-slate-800, .bg-slate-950 { background-color: #f8f9fa !important; }
            .text-slate-400, .text-slate-500 { color: #666 !important; }
            .text-white { color: #000 !important; }
            .border-slate-700, .border-slate-800 { border-color: #ccc !important; }
        }

        /* Status table styling */
        .status-pass { color: #10b981; }
        .status-fail { color: #ef4444; font-weight: 600; }
        .status-error { color: #f59e0b; }

        /* Severity badges */
        .severity-critical { background-color: rgba(239, 68, 68, 0.2); color: #fca5a5; border-color: rgba(239, 68, 68, 0.5); }
        .severity-high { background-color: rgba(249, 115, 22, 0.2); color: #fdba74; border-color: rgba(249, 115, 22, 0.5); }
        .severity-medium { background-color: rgba(234, 179, 8, 0.2); color: #fde047; border-color: rgba(234, 179, 8, 0.5); }
        .severity-low { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; border-color: rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="min-h-screen p-8 max-w-6xl mx-auto">

    <!-- Executive Header -->
    <header class="flex justify-between items-end border-b border-slate-700 pb-6 mb-8">
        <div>
            <p class="text-emerald-400 font-bold tracking-wider text-sm uppercase mb-2">Confidential Audit Report</p>
            <h1 class="text-4xl font-bold text-white mb-1">AI Security Assessment</h1>
            <p class="text-slate-400">Target: <span class="text-white mono">{{ target_url }}</span></p>
        </div>
        <div class="text-right">
            <p class="text-slate-400 text-sm">Scan Date</p>
            <p class="mono text-lg">{{ timestamp.strftime('%Y-%m-%d %H:%M') if timestamp else 'N/A' }}</p>
            <p class="text-slate-500 text-xs mt-1">ID: {{ scan_id[:8] }}</p>
            <p class="text-slate-500 text-xs">Duration: {{ "%.2f"|format(duration) }}s</p>
        </div>
    </header>

    <!-- High Level Scorecard -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <!-- Overall Grade -->
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 flex flex-col items-center justify-center">
            <h3 class="text-slate-400 text-sm uppercase font-bold mb-2">Security Score</h3>
            <div class="text-6xl font-bold {{ 'text-red-500' if score < 70 else 'text-emerald-500' }}">
                {{ score }}<span class="text-2xl text-slate-500">/100</span>
            </div>
            <p class="mt-2 text-sm {{ 'text-red-400' if score < 70 else 'text-emerald-400' }}">
                {% if score < 50 %}CRITICAL RISK{% elif score < 70 %}HIGH RISK{% elif score < 90 %}MODERATE RISK{% else %}LOW RISK{% endif %}
            </p>
        </div>

        <!-- Vulnerability Stats -->
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 col-span-2">
            <h3 class="text-slate-400 text-sm uppercase font-bold mb-4">Vulnerability Breakdown</h3>
            <div class="grid grid-cols-5 gap-3 text-center">
                <div class="p-3 bg-red-900/20 rounded-lg border border-red-900/50">
                    <div class="text-2xl font-bold text-red-400">{{ critical_count }}</div>
                    <div class="text-xs text-red-300/70 uppercase mt-1">Critical</div>
                </div>
                <div class="p-3 bg-orange-900/20 rounded-lg border border-orange-900/50">
                    <div class="text-2xl font-bold text-orange-400">{{ high_count }}</div>
                    <div class="text-xs text-orange-300/70 uppercase mt-1">High</div>
                </div>
                <div class="p-3 bg-yellow-900/20 rounded-lg border border-yellow-900/50">
                    <div class="text-2xl font-bold text-yellow-400">{{ medium_count }}</div>
                    <div class="text-xs text-yellow-300/70 uppercase mt-1">Medium</div>
                </div>
                <div class="p-3 bg-blue-900/20 rounded-lg border border-blue-900/50">
                    <div class="text-2xl font-bold text-blue-400">{{ low_count }}</div>
                    <div class="text-xs text-blue-300/70 uppercase mt-1">Low</div>
                </div>
                <div class="p-3 bg-emerald-900/20 rounded-lg border border-emerald-900/50">
                    <div class="text-2xl font-bold text-emerald-400">{{ passed_count }}</div>
                    <div class="text-xs text-emerald-300/70 uppercase mt-1">Passed</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Executive Summary -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-white mb-4 border-l-4 border-emerald-500 pl-4">Executive Summary</h2>
        <div class="bg-slate-800/50 p-6 rounded-lg text-slate-300 leading-relaxed">
            {% if critical_count > 0 or high_count > 0 %}
            <p class="mb-4"><strong class="text-red-400">ATTENTION REQUIRED:</strong>
                The target application has
                {% if critical_count > 0 %}<strong class="text-white">{{ critical_count }} critical</strong>{% endif %}
                {% if critical_count > 0 and high_count > 0 %} and {% endif %}
                {% if high_count > 0 %}<strong class="text-white">{{ high_count }} high severity</strong>{% endif %}
                vulnerabilities that require immediate attention.
            </p>
            <p>These issues could allow attackers to extract system instructions, manipulate the AI's behavior, exfiltrate sensitive data, or cause reputational damage.</p>
            {% else %}
            <p class="text-emerald-400"><strong>SYSTEM SECURE:</strong> The target application demonstrates a robust security posture. All critical injection vectors were blocked by the existing guardrails.</p>
            {% endif %}
        </div>
    </section>

    <!-- Attack Results Tables -->
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-white mb-6 border-l-4 border-blue-500 pl-4">Attack Results</h2>

        <!-- Security Attacks Table -->
        {% if security_attacks %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-red-400 mb-3 flex items-center gap-2">
                <i class="fas fa-shield-halved"></i> Security Attacks ({{ security_attacks|length }})
            </h3>
            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 text-left">Attack Type</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3 text-center">Issues</th>
                            <th class="px-4 py-3 text-right">Latency</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        {% for attack in security_attacks %}
                        <tr class="hover:bg-slate-700/30">
                            <td class="px-4 py-3 text-slate-200">{{ attack.attack_type }}</td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.status == 'FAIL' %}
                                <span class="status-fail"><i class="fas fa-times-circle"></i> FAIL</span>
                                {% elif attack.status == 'ERROR' %}
                                <span class="status-error"><i class="fas fa-exclamation-triangle"></i> ERROR</span>
                                {% else %}
                                <span class="status-pass"><i class="fas fa-check-circle"></i> PASS</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.vulnerabilities|length > 0 %}
                                <span class="text-red-400 font-semibold">{{ attack.vulnerabilities|length }}</span>
                                {% else %}
                                <span class="text-slate-500">0</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right mono text-slate-400">{{ attack.latency_ms }}ms</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Reliability Attacks Table -->
        {% if reliability_attacks %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center gap-2">
                <i class="fas fa-chart-line"></i> Reliability Tests ({{ reliability_attacks|length }})
            </h3>
            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 text-left">Test Type</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3 text-center">Issues</th>
                            <th class="px-4 py-3 text-right">Latency</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        {% for attack in reliability_attacks %}
                        <tr class="hover:bg-slate-700/30">
                            <td class="px-4 py-3 text-slate-200">{{ attack.attack_type }}</td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.status == 'FAIL' %}
                                <span class="status-fail"><i class="fas fa-times-circle"></i> FAIL</span>
                                {% elif attack.status == 'ERROR' %}
                                <span class="status-error"><i class="fas fa-exclamation-triangle"></i> ERROR</span>
                                {% else %}
                                <span class="status-pass"><i class="fas fa-check-circle"></i> PASS</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.vulnerabilities|length > 0 %}
                                <span class="text-red-400 font-semibold">{{ attack.vulnerabilities|length }}</span>
                                {% else %}
                                <span class="text-slate-500">0</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right mono text-slate-400">{{ attack.latency_ms }}ms</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Cost Attacks Table -->
        {% if cost_attacks %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-blue-400 mb-3 flex items-center gap-2">
                <i class="fas fa-dollar-sign"></i> Cost & Performance ({{ cost_attacks|length }})
            </h3>
            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-slate-900/50 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 text-left">Test Type</th>
                            <th class="px-4 py-3 text-center">Status</th>
                            <th class="px-4 py-3 text-center">Issues</th>
                            <th class="px-4 py-3 text-right">Latency</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        {% for attack in cost_attacks %}
                        <tr class="hover:bg-slate-700/30">
                            <td class="px-4 py-3 text-slate-200">{{ attack.attack_type }}</td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.status == 'FAIL' %}
                                <span class="status-fail"><i class="fas fa-times-circle"></i> FAIL</span>
                                {% elif attack.status == 'ERROR' %}
                                <span class="status-error"><i class="fas fa-exclamation-triangle"></i> ERROR</span>
                                {% else %}
                                <span class="status-pass"><i class="fas fa-check-circle"></i> PASS</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if attack.vulnerabilities|length > 0 %}
                                <span class="text-red-400 font-semibold">{{ attack.vulnerabilities|length }}</span>
                                {% else %}
                                <span class="text-slate-500">0</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right mono text-slate-400">{{ attack.latency_ms }}ms</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Detailed Vulnerability Findings -->
    {% if security_vulns or reliability_vulns or cost_vulns %}
    <section class="mb-12">
        <h2 class="text-2xl font-bold text-white mb-6 border-l-4 border-red-500 pl-4">Vulnerability Details</h2>

        <!-- Security Vulnerabilities -->
        {% if security_vulns %}
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-red-400 mb-4">
                <i class="fas fa-shield-halved"></i> Security Vulnerabilities ({{ security_vulns|length }})
            </h3>
            {% for vuln in security_vulns %}
            <div class="card bg-slate-800 rounded-xl border border-slate-700 mb-6 overflow-hidden break-inside-avoid">
                <!-- Header -->
                <div class="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold px-2 py-1 rounded border severity-{{ vuln.severity.value|lower }}">
                            {{ vuln.severity.value }}
                        </span>
                        <h4 class="font-bold text-lg text-white">{{ vuln.name }}</h4>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <p class="text-slate-300 text-sm mb-6">{{ vuln.description }}</p>

                    <!-- Evidence Chat Bubbles -->
                    <h5 class="text-slate-400 text-xs uppercase font-bold mb-3">Attack Evidence</h5>
                    <div class="space-y-3 text-sm">
                        <!-- User Prompt -->
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-slate-300"></i>
                            </div>
                            <div class="bg-slate-700 p-3 rounded-lg rounded-tl-none text-slate-200 max-w-2xl">
                                <p class="mono text-xs text-slate-400 mb-1">Attack Input</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_request[:500] }}{% if vuln.evidence_request|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>

                        <!-- AI Response -->
                        <div class="flex gap-3 flex-row-reverse">
                            <div class="w-8 h-8 rounded-full bg-red-900/50 flex items-center justify-center flex-shrink-0 border border-red-500/30">
                                <i class="fas fa-robot text-red-400"></i>
                            </div>
                            <div class="bg-red-900/20 border border-red-900/50 p-3 rounded-lg rounded-tr-none text-red-200 max-w-2xl">
                                <p class="mono text-xs text-red-400/70 mb-1">AI Response (Vulnerable)</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_response[:500] }}{% if vuln.evidence_response|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Reliability Vulnerabilities -->
        {% if reliability_vulns %}
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-yellow-400 mb-4">
                <i class="fas fa-chart-line"></i> Reliability Issues ({{ reliability_vulns|length }})
            </h3>
            {% for vuln in reliability_vulns %}
            <div class="card bg-slate-800 rounded-xl border border-slate-700 mb-6 overflow-hidden break-inside-avoid">
                <div class="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold px-2 py-1 rounded border severity-{{ vuln.severity.value|lower }}">
                            {{ vuln.severity.value }}
                        </span>
                        <h4 class="font-bold text-lg text-white">{{ vuln.name }}</h4>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-slate-300 text-sm mb-6">{{ vuln.description }}</p>
                    <h5 class="text-slate-400 text-xs uppercase font-bold mb-3">Evidence</h5>
                    <div class="space-y-3 text-sm">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-slate-300"></i>
                            </div>
                            <div class="bg-slate-700 p-3 rounded-lg rounded-tl-none text-slate-200 max-w-2xl">
                                <p class="mono text-xs text-slate-400 mb-1">Input</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_request[:500] }}{% if vuln.evidence_request|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>
                        <div class="flex gap-3 flex-row-reverse">
                            <div class="w-8 h-8 rounded-full bg-yellow-900/50 flex items-center justify-center flex-shrink-0 border border-yellow-500/30">
                                <i class="fas fa-robot text-yellow-400"></i>
                            </div>
                            <div class="bg-yellow-900/20 border border-yellow-900/50 p-3 rounded-lg rounded-tr-none text-yellow-200 max-w-2xl">
                                <p class="mono text-xs text-yellow-400/70 mb-1">AI Response</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_response[:500] }}{% if vuln.evidence_response|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Cost Vulnerabilities -->
        {% if cost_vulns %}
        <div class="mb-8">
            <h3 class="text-xl font-semibold text-blue-400 mb-4">
                <i class="fas fa-dollar-sign"></i> Cost & Performance Issues ({{ cost_vulns|length }})
            </h3>
            {% for vuln in cost_vulns %}
            <div class="card bg-slate-800 rounded-xl border border-slate-700 mb-6 overflow-hidden break-inside-avoid">
                <div class="bg-slate-900/50 p-4 border-b border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold px-2 py-1 rounded border severity-{{ vuln.severity.value|lower }}">
                            {{ vuln.severity.value }}
                        </span>
                        <h4 class="font-bold text-lg text-white">{{ vuln.name }}</h4>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-slate-300 text-sm mb-6">{{ vuln.description }}</p>
                    <h5 class="text-slate-400 text-xs uppercase font-bold mb-3">Evidence</h5>
                    <div class="space-y-3 text-sm">
                        <div class="flex gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-slate-300"></i>
                            </div>
                            <div class="bg-slate-700 p-3 rounded-lg rounded-tl-none text-slate-200 max-w-2xl">
                                <p class="mono text-xs text-slate-400 mb-1">Input</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_request[:500] }}{% if vuln.evidence_request|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>
                        <div class="flex gap-3 flex-row-reverse">
                            <div class="w-8 h-8 rounded-full bg-blue-900/50 flex items-center justify-center flex-shrink-0 border border-blue-500/30">
                                <i class="fas fa-robot text-blue-400"></i>
                            </div>
                            <div class="bg-blue-900/20 border border-blue-900/50 p-3 rounded-lg rounded-tr-none text-blue-200 max-w-2xl">
                                <p class="mono text-xs text-blue-400/70 mb-1">AI Response</p>
                                <p class="whitespace-pre-wrap">{{ vuln.evidence_response[:500] }}{% if vuln.evidence_response|length > 500 %}...{% endif %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endif %}

    <!-- Verbose Raw Logs Section -->
    {% if include_raw_log and raw_log %}
    <section class="mb-12 no-print">
        <h2 class="text-2xl font-bold text-white mb-6 border-l-4 border-purple-500 pl-4">Raw Request/Response Log</h2>
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
            <p class="text-slate-400 text-sm mb-4">Detailed request/response pairs from the scan ({{ raw_log|length }} entries)</p>
            {% for entry in raw_log %}
            <details class="mb-2">
                <summary class="cursor-pointer bg-slate-700/50 p-3 rounded hover:bg-slate-700 text-slate-300 text-sm">
                    <span class="mono">{{ (entry.prompt or entry.question or entry.payload or 'Entry')[:60] }}{% if (entry.prompt or entry.question or entry.payload or '')|length > 60 %}...{% endif %}</span>
                </summary>
                <pre class="bg-slate-900 p-4 rounded mt-2 text-xs text-slate-400 overflow-x-auto">{{ entry | tojson(indent=2) }}</pre>
            </details>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- CTA Footer -->
    <footer class="mt-16 pt-8 border-t border-slate-800 text-center">
        <p class="text-slate-500 mb-6">This report was generated by the AI Security Scanner.</p>
        <a href="{{ cta_url }}" class="no-print inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-900/30">
            <i class="fas fa-shield-halved mr-2"></i> {{ cta_text }}
        </a>
        <p class="text-slate-600 text-xs mt-6 print:mt-2">&copy; {{ timestamp.strftime('%Y') if timestamp else '2024' }} AI Security Scanner</p>
    </footer>

</body>
</html>
